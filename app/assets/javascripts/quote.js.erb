function plan_test(plan, criteria){
  result = true
  critters = criteria.length
  for (var j=0; j< critters; j++){
    criteria_type = criteria[j][0]
    criteria_value = criteria[j][1]
    if ((criteria_type == 'carriers') && (criteria_value != plan[5]))   {result=false; break; }
    if ((criteria_type == 'metals') && (criteria_value != plan[0]))     {result=false; break; }
    if ((criteria_type == 'plan_types') && (criteria_value != plan[2])) {result=false; break; }
    if ((criteria_type == 'nationwide') && (criteria_value != String(plan[6]))) {result=false; break; }
    if ((criteria_type == 'dc_in_network') && (criteria_value != String(plan[7]))) {result=false; break; }
  }
   if (plan[3] > deductible_value) {result=false}
  return result
}

function set_plan_counts() {
    $('#show_plan_criteria_count').text('Plans that meet your criteria: ' + String(window.available_plans))
    $('#show_plan_selected_count').text('You have selected ' + String($('.btn.active').size()) +' plans.')
}

function toggle_plans(){
  window.criteria = []
  $.each($('.plan_selectors .active'), function() {
      criteria_type = this.parentNode.id
      criteria_value = this.id
      if (criteria_value != 'any') {window.criteria.push([criteria_type,criteria_value])}
    })
  window.available_plans = 0
  for(var i = 0; i < plan_count; i++) {
      plan = window.select_plans[i]
      value = "[value~=" + plan[4] + "]"
      display = plan_test(plan, window.criteria) ? 'inline' : 'none'
      $(value).parent().css('display', display)
      if (display=='inline') {window.available_plans += 1}
  }

  // Show number of available plans based on the selection criteria 
  $('#x-of-plans').html($('#quote-plan-list > label:visible').length);
  set_plan_counts()
}
function collapse_all(){
  //bootstrapslider labels will have zero width unless the sliders are initially visible before being hidden
  setTimeout(function(){ 
    $('[aria-controls="quote-mgmt"]').attr('aria-expanded', false)
    $('#quote-mgmt').removeClass('in')
    $('[aria-controls="feature-mgmt"]').attr('aria-expanded', false)
    $('#feature-mgmt').removeClass('in')
    $('[aria-controls="plan-selection-mgmt"]').attr('aria-expanded', false)
    $('#plan-selection-mgmt').removeClass('in')
    },0)
}

window.relationships = ['employee', 'spouse', 'domestic_partner', 'child_under_26']
function set_benefits () {
    $('#pct_employee').bootstrapSlider('setValue',window.relationship_benefits['employee']);
    $('#pct_spouse').bootstrapSlider('setValue', window.relationship_benefits['spouse']);
    $('#pct_domestic_partner').bootstrapSlider('setValue', window.relationship_benefits['domestic_partner']);
    $('#pct_child_under_26').bootstrapSlider('setValue', window.relationship_benefits['child_under_26']);
}
function slider_listeners () {
    $('#ex1').bootstrapSlider({});
    $('#total_plan_cost').bootstrapSlider({});
    $('#pct_employee').bootstrapSlider({});
    $('#pct_spouse').bootstrapSlider({});
    $('#pct_domestic_partner').bootstrapSlider({});
    $('#pct_child_under_26').bootstrapSlider({});
    $('#employees_on_roster').bootstrapSlider({});
    $('#ex1').on('slideStop', function(){deductible_value = this.value;
      toggle_plans();
      console.log(this.value, 'v')
    })
    $('#pct_employee').on('slideStop', function() {
        val =$('#pct_employee').bootstrapSlider('getValue')
        set_relationship_pct('employee', val)
       })
    $('#pct_spouse').on('slideStop', function() {
          val =$('#pct_spouse').bootstrapSlider('getValue')
          set_relationship_pct('spouse', val)
         })
    $('#pct_domestic_partner').on('slideStop', function() {
          val =$('#pct_domestic_partner').bootstrapSlider('getValue')
          set_relationship_pct('domestic_partner', val)
         })
    $('#pct_child_under_26').on('slideStop', function() {
          val =$('#pct_child_under_26').bootstrapSlider('getValue')
          set_relationship_pct('child_under_26', val)
         })
    $('#employees_on_roster').on('slideStop', function(){
       $('#employee_count').val($('#employees_on_roster').bootstrapSlider('getValue'))
    })

    $('.plan_buttons .btn').on('click', function() {
    delta=$(this).hasClass('active') ? -1 : 1;
    adjusted_count = $('.btn.active').size() + delta
     $('#show_plan_selected_count').text('You have selected ' + String(adjusted_count) + ' plans.' )
      })
    set_benefits()

    $('.publish td').on('click',
       function(){
        td = $(this)
        quote_id=$('#quote').val()
        plan_id=td.parent().attr('id')
        elected=td.index()
        cost = td.html()
        params='?quote_id='+quote_id+'&plan_id='+plan_id+'&elected='+String(elected)+'&cost='+cost
        window.location= '/broker_agencies/quotes/publish.js' + params
    })
    $('#quote').on('change',
       function(){
        quote_id = $(this).val()
        console.log(quote_id)
        $.ajax({
          type: 'GET',
          data: {quote: quote_id},
          url: '/broker_agencies/quotes/get_quote_info.js'
        }).done(function(response){
            window.relationship_benefits = response['relationship_benefits']
            window.roster_premiums = response['roster_premiums']
            set_benefits()
        })
    })
}
function set_relationship_pct(relationship, val) {
  window.relationship_benefits[relationship] = val
  $("[name~='" + relationship + "']").val(val)
  $.ajax({
    type: 'POST',
    data: {benefits: window.relationship_benefits, id: $('#quote option:selected').val() },
    url: '/broker_agencies/quotes/update_benefits.js',
  }).done(function(response){
    window.plan_costs = response
  })
}
